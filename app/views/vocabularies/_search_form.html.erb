<%# 検索フォーム %>
<%= search_form_for q, url: vocabularies_path, method: :get,
      class: "mb-4 grid grid-cols-1 md:grid-cols-4 gap-3" do |f| %>
<%# キーワード入力欄 %>
  <%= f.search_field :word_or_meaning_cont,
        placeholder: t("placeholders.keyword"), class: "rounded-xl border px-3 py-2" %>

  <%= f.select :part_of_speech_eq,
        Vocabulary.part_of_speeches.map { |k, v| [t("enums.vocabulary.part_of_speech.#{k}"), v] },
        { include_blank: t(".all_part_of_speech") }, class: "rounded-xl border px-3 py-2" %>

  <%# タグ選択（モーダル／大量・長文対応） %>
  <div class="md:col-span-2">
    <% tags = VocabularyTag.where(user: current_user).order(:name) %>
    <% selected = Array(params.dig(:q, :vocabulary_tags_id_in)).map(&:to_s) %>

    <button type="button"
            onclick="document.getElementById('vocabularyTagDialog').showModal()"
            class="rounded-xl border px-3 py-2 flex bg-white text-left hover:bg-gray-100">
      <%= t("common.choice_tag") %>
    </button>

    <dialog id="vocabularyTagDialog" class="p-0 w-full max-w-2xl rounded-2xl">
      <div class="flex flex-col max-h-[70vh]">
        <div class="px-4 py-3 border-b sticky top-0 bg-white rounded-t-2xl">
          <div class="font-semibold"><%= t("common.choice_tag") %></div>
        </div>

        <div class="p-4 overflow-y-auto">
          <% if tags.any? %>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <% tags.each do |tag| %>
                <label class="flex items-start gap-2 text-sm">
                  <%= check_box_tag "q[vocabulary_tags_id_in][]",
                                    tag.id,
                                    selected.include?(tag.id.to_s),
                                    id: dom_id(tag) %>
                  <span class="break-words whitespace-normal leading-5"><%= tag.name %></span>
                </label>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-sm"><%= t("common.tag_none") %></p>
          <% end %>
        </div>

        <div class="px-4 py-3 border-t bg-white sticky bottom-0 rounded-b-2xl flex justify-between">
          <button type="button"
                  onclick="(function(d){d.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false)})(document.getElementById('vocabularyTagDialog'))"
                  class="px-4 py-2 rounded-xl border bg-white hover:shadow-lg active:translate-y-0.5 transition duration-150">
            <%= t("common.reset")%>
          </button>
          <div class="space-x-2">
            <button type="button"
                    onclick="document.getElementById('vocabularyTagDialog').close()"
                    class="px-4 py-2 rounded-xl border bg-white hover:shadow-lg active:translate-y-0.5 transition duration-150">
              <%= t("common.close")%>
            </button>
            <button type="button"
                    onclick="document.getElementById('vocabularyTagDialog').close()"
                    class="px-4 py-2 rounded-xl bg-orange-500 text-white hover:shadow-lg active:translate-y-0.5 transition duration-150">
              <%= t("common.specify")%>
            </button>
          </div>
        </div>
      </div>
    </dialog>
  </div>

<%# 検索ボタン + 日付絞り込み（下段） %>
  <div class="md:col-span-4 grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
    <div class="flex gap-2">
      <%= f.submit "検索", class: "rounded-xl bg-blue-600 text-white px-4 py-2 hover:bg-blue-700 transition hover:shadow-lg active:translate-y-0.5 duration-150" %>
      <%= link_to "クリア", vocabularies_path, class: "hover:shadow-lg active:translate-y-0.5 transition duration-150 rounded-xl border bg-white px-4 py-2 hover:bg-gray-300" %>
    </div>
    <div>
      <%= f.label :created_at_gteq, t("common.from"), class: "block text-sm mb-1" %>
      <%= f.date_field :created_at_gteq, class: "rounded-xl border px-3 py-2 w-full" %>
    </div>
    <div>
      <%= f.label :created_at_lteq, t("common.to"), class: "block text-sm mb-1" %>
      <%= f.date_field :created_at_lteq, class: "rounded-xl border px-3 py-2 w-full" %>
    </div>
    <div></div>
  </div>
<% end %>
